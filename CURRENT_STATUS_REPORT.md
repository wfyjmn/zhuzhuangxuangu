# 📊 DeepQuant 程序状态报告

**生成时间**: 2026-01-31 19:42
**报告目的**: 全面梳理当前程序状态、突击选股状态、大模型训练状态

---

## 🎯 一、程序概览

### 1.1 项目结构

```
/workspace/projects/
├── assets/
│   ├── 柱形选股-筛选.py        # 第1轮筛选（传统规则选股）
│   ├── 柱形选股-第2轮.py        # 第2轮筛选（评分排序）
│   ├── main_controller.py      # 主控制器（协调各模块）
│   ├── market_weather.py       # 天气预报系统（大势择时）
│   ├── multi_factor_model.py   # 多因子模型（资金流+板块共振）
│   ├── ai_referee.py           # AI裁判（XGBoost分类器）
│   ├── ai_backtest_generator.py # AI回测数据生成器
│   ├── train_optimized.py      # 训练脚本（终极优化版）
│   └── train_real_data.py      # 真实数据训练脚本
├── assets/models/              # 模型文件目录
├── assets/data/                # 数据文件目录
└── scripts/                    # 工具脚本
```

### 1.2 核心模块状态

| 模块 | 文件 | 状态 | 说明 |
|------|------|------|------|
| **选股系统** | 柱形选股-筛选.py | ✅ 可用 | 基于传统规则的多因子选股 |
| **选股系统** | 柱形选股-第2轮.py | ✅ 可用 | 评分排序和风控 |
| **主控制器** | main_controller.py | ✅ 可用 | 协调各模块运行 |
| **天气预报** | market_weather.py | ✅ 可用 | 大势择时（涨/跌/震荡） |
| **多因子模型** | multi_factor_model.py | ✅ 可用 | 资金流+板块共振 |
| **AI裁判** | ai_referee.py | ✅ 可用 | XGBoost/LightGBM分类器 |
| **数据生成** | ai_backtest_generator.py | ✅ 可用 | 生成训练数据 |
| **训练脚本** | train_optimized.py | ✅ 可用 | 终极优化版训练 |
| **训练脚本** | train_real_data.py | ✅ 可用 | 真实数据训练 |

---

## 📈 二、突击选股系统状态

### 2.1 选股策略（当前使用的是传统规则选股）

#### 第1轮筛选（柱形选股-筛选.py）

**策略类型**:
1. **★低位强攻**: 底部放量 + 大涨（涨幅>2.5%）+ 阳线
2. **☆缩量洗盘**: 上升趋势 + 缩量回调（量比<1.05）+ 支撑有效
3. **▲梯量上行**: 梯量形态 + 红盘

**关键指标**:
- 量比（vol_ratio）: 当前成交量 / 5日均量
- 位置比例（pos_ratio）: (当前价 - 250日最低价) / (250日最高价 - 250日最低价)
- 形态识别（patterns）: 倍量、缩量、梯量、高量、地量、平量
- 均线系统: MA5, MA20, MA60

**过滤条件**:
- 剔除ST股票
- 剔除科创板（688）
- 剔除创业板（30）
- 剔除北交所（.BJ）
- 剔除高位股票（pos_ratio > 0.8）

#### 第2轮筛选（柱形选股-第2轮.py）

**评分系统**（四个维度，满分100分）:
1. **安全性（s_safe, 25分）**: 基于位置比例和量比
2. **进攻性（s_off, 35分）**: 基于策略类型、量比、涨幅
3. **确定性（s_cert, 25分）**: 基于成交量突破、均线支撑
4. **配合度（s_match, 15分）**: 基于位置和成交量的配合

**风控双轨制**:
- 正常策略: 阈值 ≥ 55分
- 缩量洗盘: 阈值 ≥ 45分（更宽松，保护洗盘）

**换手率控制**:
- 正常策略: 换手率 < 1.5%
- 缩量洗盘: 换手率 < 0.6%

### 2.2 最新选股结果

**文件**: `assets/Best_Pick_20260129.csv`
**日期**: 2026-01-29
**股票数量**: 约100只

**Top 10 示例**:

| 股票代码 | 股票名称 | 策略 | 收盘价 | 涨幅 | 量比 | 位置比例 | 原因 |
|---------|---------|------|--------|------|------|----------|------|
| 002232.SZ | 启明信息 | ★低位强攻 | 20.27 | 5.68% | 2.06 | 0.24 | 底部放量,涨幅5.7% |
| 002068.SZ | 黑猫股份 | ★低位强攻 | 9.72 | 5.65% | 1.80 | 0.25 | 底部放量,涨幅5.7% |
| 600997.SH | 开滦股份 | ★低位强攻 | 6.18 | 5.46% | 1.79 | 0.28 | 底部放量,涨幅5.5% |
| 600123.SH | 兰花科创 | ★低位强攻 | 6.20 | 4.91% | 1.64 | 0.28 | 底部放量,涨幅4.9% |
| 603072.SH | 天和磁材 | ★低位强攻 | 45.99 | 4.88% | 1.94 | 0.33 | 底部放量,涨幅4.9% |

### 2.3 选股系统评估

**优点**:
- ✅ 逻辑清晰，易于理解
- ✅ 基于成熟的量价理论
- ✅ 有风控机制（双轨制、换手率控制）
- ✅ 每日都有选股结果

**缺点**:
- ❌ 完全基于人工规则，缺乏学习能力
- ❌ 无法适应市场变化
- ❌ 参数需要人工调整

---

## 🤖 三、大模型训练状态

### 3.1 AI裁判（AI Referee）

**类型**: XGBoost/LightGBM 分类器
**目标**: 二分类（未来5天盈利 vs 亏损）
**输入**: 66-74个技术指标特征
**输出**: 概率（0-1）

**核心特征**（Top 10）:
1. up_down_ratio: 0.0681
2. support_20: 0.0284
3. resistance_20: 0.0211
4. limit_up_ma5: 0.0187
5. turnover_rate: 0.0173
6. low_20: 0.0170
7. high_20: 0.0168
8. price_above_ma5: 0.0164
9. ma_60: 0.0154
10. limit_down_ma5: 0.0153

### 3.2 训练历史

#### 训练1: precision_training.log (2026-01-05)

**数据规模**:
- 总样本: 217,615
- 训练集: 130,569（正样本: 26,171, 20.04%）
- 验证集: 43,523（正样本: 7,225, 16.60%）
- 测试集: 43,523（正样本: 6,721, 15.44%）
- 特征数: 74

**优化配置**:
- Optuna 试验次数: 50
- 优化指标: precision（精确率）
- 优化方向: maximize

**最优参数**:
```python
{
    'learning_rate': 0.0398,
    'max_depth': 7,
    'min_child_weight': 8,
    'subsample': 0.9029,
    'colsample_bytree': 0.9940,
    'reg_lambda': 4.8259,
    'reg_alpha': 1.3286,
    'gamma': 4.3893,
    'scale_pos_weight': 1.0033,
    'n_estimators': 1149
}
```

**测试集性能**:
- 准确率: 84.48%
- 精确率: 34.86%
- 召回率: 0.57%
- F1分数: 0.011
- AUC: **0.5420** ⚠️

**模型文件**: `assets/models/auto_tuned_model.pkl` (2.3M)

#### 训练2: precision_training_restart.log (2026-01-05)

**数据规模**:
- 总样本: 434,900
- 训练集: 260,940（正样本: 91,827, 35.19%）
- 验证集: 86,980（正样本: 25,414, 29.22%）
- 测试集: 86,980（正样本: 26,223, 30.15%）
- 特征数: 66

**优化配置**:
- Optuna 试验次数: 100
- 优化指标: f1（F1分数）
- 优化方向: maximize

**最佳F1**: 0.4714（试验31）

**状态**: ⚠️ 日志不完整，只显示了51次试验

#### 训练3: train_real_data.log (2026-01-30)

**数据规模**:
- 样本数: 15（干运行模式）
- 正样本: 3 (20.00%)
- 特征数: 23

**状态**: ⚠️ 干运行模式，数据量太小

### 3.3 模型性能评估

| 模型 | AUC | 精确率 | 召回率 | F1 | 状态 |
|------|-----|--------|--------|-----|------|
| auto_tuned_model | **0.5420** | 34.86% | 0.57% | 0.011 | ⚠️ 性能一般 |
| precision_training_restart | 未知 | 未知 | 未知 | 0.4714 | ⚠️ 训练未完成 |

**关键问题**:
- AUC只有0.5420，略高于随机猜测（0.5）
- 精确率只有34.86%，无法达到实用的≥60%
- 召回率极低（0.57%），漏掉了大量盈利机会
- F1分数极低（0.011），整体性能不佳

### 3.4 V5.0 "三大手术"（已完成但未完全应用）

根据之前的记录，进行了以下优化：

1. **手术一**: 解除封印（扩大样本量）
   - 将 `max_samples` 从 10,000 增加到 500,000
   - 状态: ✅ 代码已修改

2. **手术二**: 注入灵魂（补全缺失的特征）
   - 修改 `data_warehouse.py` 合并 `daily_basic` 接口数据
   - 补充 turnover_rate, pe_ttm 等特征
   - 状态: ✅ 代码已修改

3. **手术三**: 修复"相对收益"标签
   - 修改 `ai_backtest_generator.py` 增加临时下载上证指数功能
   - 引入相对收益标签（熊市跑赢大盘即赢）
   - 状态: ✅ 代码已修改

**问题**: 这些优化没有重新训练模型！

### 3.5 训练配置（train_optimized.py）

**当前配置**:
```python
TRAINING_CONFIG = {
    'start_date': '20230101',
    'end_date': '20241231',
    'amount_threshold': 10000,
    'max_candidates': 100,
    'max_samples': 500000,  # 手术一：样本量增加50倍
    'n_splits': 5,
    'model_type': 'xgboost',
    'use_float32': True,
}
```

**状态**: ✅ 配置已更新，但未运行

---

## 🔍 四、当前存在的问题

### 4.1 核心问题

1. **模型性能不足**
   - AUC只有0.5420，远低于实用的≥0.7
   - 精确率只有34.86%，远低于目标≥60%
   - 召回率极低（0.57%），漏掉了大量机会

2. **优化未应用**
   - V5.0"三大手术"已完成代码修改
   - 但没有使用新配置重新训练模型
   - 当前使用的模型仍然是旧版本

3. **训练数据不足**
   - 2023-01-01到2024-12-31的数据已下载
   - 但只有15个样本（干运行模式）
   - 需要运行完整训练（50万样本）

### 4.2 次要问题

1. **缺少模型集成**
   - 传统规则选股和AI裁判没有整合
   - 目前是两套独立系统

2. **缺少实时预测**
   - AI裁判只能训练，不能实时预测
   - 没有每日选股功能

3. **缺少回测验证**
   - 没有回测AI裁判的选股表现
   - 无法评估真实收益

---

## 📋 五、推荐行动计划

### 优先级1：提升模型性能（必须）

1. **重新训练模型（使用V5.0配置）**
   ```bash
   cd assets
   python train_optimized.py
   ```
   - 时间范围: 2023-2024
   - 样本量: 50万
   - 使用Turbo模式加速

2. **评估新模型性能**
   - 检查AUC是否≥0.7
   - 检查精确率是否≥60%
   - 检查召回率是否≥30%

3. **优化参数调优**
   - 如果性能不达标，调整Optuna参数
   - 尝试不同的优化指标（AUC、F1、Precision）
   - 增加试验次数（200次）

### 优先级2：集成AI裁判到选股系统（重要）

1. **创建实时预测脚本**
   ```python
   # assets/predict_with_ai_referee.py
   # 使用训练好的模型预测今日股票
   ```

2. **修改主控制器**
   - 在第2轮筛选中加入AI裁判评分
   - 综合规则评分和AI概率

3. **回测验证**
   - 对比纯规则选股 vs 规则+AI选股
   - 计算收益率、胜率、最大回撤

### 优先级3：完善数据管道（可选）

1. **增量更新**
   ```bash
   bash run_full_incremental_update.sh
   ```
   - 补充最新的股票数据
   - 保持数据最新

2. **数据质量检查**
   - 检查缺失值
   - 检查异常值
   - 清洗数据

---

## 🎯 六、最终状态总结

### 6.1 突击选股系统

**状态**: ✅ 运行正常
**方法**: 传统规则选股（量价形态）
**结果**: 每日选股约100只
**优点**: 逻辑清晰，稳定性好
**缺点**: 缺乏学习能力，无法适应市场变化

### 6.2 大模型训练系统

**状态**: ⚠️ 性能不足，需要优化
**方法**: XGBoost分类器
**结果**: AUC=0.5420, 精确率=34.86%
**优点**: 可学习，可优化
**缺点**: 性能不达标，优化未应用

### 6.3 整体系统

**状态**: 🔄 两套独立系统，未整合
**功能**:
- 传统规则选股: ✅ 可用
- AI裁判训练: ⚠️ 性能不足
- AI裁判预测: ❌ 未实现
- 规则+AI集成: ❌ 未实现

**建议**: 优先提升AI裁判性能，然后集成到选股系统

---

**报告生成时间**: 2026-01-31 19:42
**下一步**: 运行 `train_optimized.py` 重新训练模型
