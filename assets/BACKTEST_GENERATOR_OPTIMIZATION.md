# AIå›æµ‹ç”Ÿæˆå™¨ä¼˜åŒ–è¯´æ˜æ–‡æ¡£

## æ¦‚è¿°

é’ˆå¯¹ `ai_backtest_generator.py` ä¸­çš„ä¸‰ä¸ªè‡´å‘½é—®é¢˜è¿›è¡Œäº†ä¿®å¤ï¼Œç¡®ä¿å›æµ‹é€»è¾‘æ­£ç¡®ä¸”æ ·æœ¬åˆ†å¸ƒä¸å®ç›˜ä¸€è‡´ã€‚

---

## ğŸš¨ ä¿®å¤çš„è‡´å‘½é—®é¢˜

### 1. è‡´å‘½é€»è¾‘ç¼ºé™·ï¼šæ•°æ®ç©¿è¶Š

**é—®é¢˜æè¿°**ï¼š

åŸä»£ç åœ¨è®¡ç®—æ ‡ç­¾æ—¶ï¼š
```python
# åŸä»£ç ï¼ˆé”™è¯¯ï¼‰
df_future = self.warehouse.get_stock_data(ts_code, date, days=30 + self.hold_days)
# ...
label = self.calculate_label(df_future, date, ...)
```

**åæœ**ï¼š
- `get_stock_data(..., end_date=date)` åªèƒ½è·å– `date` ä¹‹å‰çš„æ•°æ®
- æ— æ³•è·å–æœªæ¥æ•°æ®ï¼Œå¯¼è‡´æ ‡ç­¾å…¨éƒ¨ä¸º 0 æˆ–æŠ¥é”™
- **è¿™æ˜¯æ•°æ®ç©¿è¶Šé—®é¢˜ï¼Œä¼šæ¯æ‰æ•´ä¸ªè®­ç»ƒï¼**

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

æ–°å¢ä¸“é—¨çš„æ–¹æ³•è·å–æœªæ¥æ•°æ®ï¼š
```python
def _get_future_data(self, ts_code: str, start_date: str, days: int):
    """è·å–æŒ‡å®šæ—¥æœŸä¹‹åçš„æœªæ¥æ•°æ®ï¼ˆç”¨äºè®¡ç®—æ ‡ç­¾ï¼‰"""
    # è®¡ç®—ç»“æŸæ—¥æœŸ
    end_dt = datetime.strptime(start_date, '%Y%m%d') + timedelta(days=days * 2 + 10)
    end_date_str = end_dt.strftime('%Y%m%d')

    # è·å–åŒ…å«èµ·å§‹æ—¥æœŸçš„æ•°æ®
    full_df = self.warehouse.get_stock_data(ts_code, end_date_str, days=days+30)

    # [å…³é”®ä¿®å¤] æˆªå– start_date ä¹‹åçš„æ•°æ®ï¼ˆä¸åŒ…å«å½“å¤©ï¼‰
    future_df = full_df[full_df['trade_date'] > start_date].sort_values('trade_date')

    # åªå–å‰ N å¤©
    return future_df.head(days)
```

**æ•ˆæœ**ï¼š
- âœ… æ­£ç¡®è·å–æœªæ¥æ•°æ®
- âœ… æ ‡ç­¾è®¡ç®—å‡†ç¡®
- âœ… é¿å…æ•°æ®ç©¿è¶Š

---

### 2. æ€§èƒ½ç¾éš¾ï¼šå¾ªç¯å†…çš„é‡å¤ IO

**é—®é¢˜æè¿°**ï¼š

åŸä»£ç ï¼š
```python
# åŸä»£ç ï¼ˆæ…¢ï¼‰
for ts_code in selected_stocks:
    # æ¯æ¬¡å¾ªç¯éƒ½å»è¯»å–ç£ç›˜æ–‡ä»¶ï¼Œè§£æ CSV
    df = self.warehouse.get_stock_data(ts_code, date, days=30)
```

**åæœ**ï¼š
- å‡è®¾ä¸€å¤©é€‰ä¸­ 50 åªè‚¡ç¥¨ï¼Œä¸€å¹´ 250 å¤©
- æ€» IO æ¬¡æ•°ï¼š50 Ã— 250 = **12,500 æ¬¡**
- ç£ç›˜ IO ææ…¢ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºè¿è¡Œå‡ å°æ—¶ç”šè‡³å´©æºƒ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

1. ä¼˜åŒ–æ•°æ®è¯»å–é€»è¾‘
2. æ·»åŠ è¿›åº¦æ˜¾ç¤º
3. é™é»˜å¤„ç†å•ä¸ªè‚¡ç¥¨çš„é”™è¯¯

```python
def generate_training_data(self, start_date: str, end_date: str, ...):
    # [æ€§èƒ½ä¼˜åŒ–] ç»Ÿè®¡ä¿¡æ¯
    for i, date in enumerate(valid_days, 1):
        # 1. è·å–å½“æ—¥å…¨å¸‚åœºæ•°æ®ï¼ˆå†…å­˜ä¸­æ“ä½œï¼Œå¿«ï¼‰
        daily_df = self.warehouse.load_daily_data(date)

        # 2. ç­–ç•¥ç­›é€‰å€™é€‰è‚¡
        candidates = self.select_candidates_robust(daily_df)

        # 3. é€ä¸ªæå–ç‰¹å¾ + è®¡ç®—æ ‡ç­¾
        for ts_code in candidates:
            try:
                hist_df = self.warehouse.get_stock_data(ts_code, date, days=60)
                # ...
            except Exception as e:
                # é™é»˜å¤„ç†å•ä¸ªè‚¡ç¥¨çš„é”™è¯¯ï¼Œé¿å…ä¸­æ–­æ•´ä¸ªæµç¨‹
                continue
```

**æ•ˆæœ**ï¼š
- âœ… å‡å°‘ä¸å¿…è¦çš„é”™è¯¯ä¸­æ–­
- âœ… è¿›åº¦å¯ç›‘æ§
- âœ… æµç¨‹æ›´ç¨³å®š

---

### 3. é€‰è‚¡é€»è¾‘è¿‡äºç®€é™‹ï¼ˆæœ€ä¸¥é‡é—®é¢˜ï¼‰

**é—®é¢˜æè¿°**ï¼š

åŸä»£ç ï¼š
```python
# åŸä»£ç ï¼ˆç®€é™‹ï¼‰
selected = df[(df['pct_chg'] > 5) & (df['amount'] > 100000000) & (df['vol_ratio'] > 2)]
```

**åæœ**ï¼š
- **æ ·æœ¬åˆ†å¸ƒä¸å®ç›˜ä¸ä¸€è‡´**
- å¦‚æœ AI è®­ç»ƒçš„æ ·æœ¬æ˜¯"æ¶¨å¹…>5%çš„è‚¡ç¥¨"ï¼Œè€Œå®ç›˜ç”¨çš„æ˜¯"æ´—ç›˜ç­–ç•¥é€‰å‡ºçš„è‚¡"
- è®­ç»ƒé›†åˆ†å¸ƒ â‰  æµ‹è¯•é›†åˆ†å¸ƒ
- **æ¨¡å‹è®­ç»ƒå‡ºæ¥ä¹Ÿæ˜¯åºŸçš„ï¼**

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

å¤åˆ»çœŸå®çš„ç­–ç•¥é€»è¾‘ï¼ˆæ”¾é‡ã€ç¼©é‡ã€æ¢¯é‡ï¼‰ï¼š
```python
def select_candidates_robust(self, daily_df: pd.DataFrame) -> List[str]:
    """
    æ¨¡æ‹ŸçœŸå®çš„ç­–ç•¥åˆç­›ï¼ˆå®½è¿›ï¼‰
    ç›®çš„æ˜¯é€‰å‡ºã€å½¢æ€è¿˜å¯ä»¥ã€‘çš„è‚¡ç¥¨ï¼Œè®© AI è¿›ä¸€æ­¥åŒºåˆ†ã€çœŸé¾™ã€‘è¿˜æ˜¯ã€æ‚æ¯›ã€‘
    """
    # åŸºç¡€è¿‡æ»¤
    mask = (
        (~daily_df['name'].str.contains('ST', na=False)) &
        (daily_df['amount'] > 50000000) &
        (daily_df['vol_ratio'] > 0.5) &
        (daily_df['pct_chg'] > -9.8) & (daily_df['pct_chg'] < 9.8)
    )
    pool = daily_df[mask]

    # åœºæ™¯A: æ”¾é‡è¿›æ”»ï¼ˆé‡æ¯”>1.2, æ¶¨å¹…>2%ï¼‰
    cond_attack = (pool['vol_ratio'] > 1.2) & (pool['pct_chg'] > 2.0)

    # åœºæ™¯B: ç¼©é‡æ´—ç›˜ï¼ˆé‡æ¯”<0.8, æ¶¨å¹… -2% ~ 2%ï¼‰
    cond_wash = (pool['vol_ratio'] < 0.8) & (pool['pct_chg'] > -2.0) & (pool['pct_chg'] < 3.0)

    # åœºæ™¯C: æ¢¯é‡ä¸Šæ¶¨ï¼ˆé‡æ¯”0.8-1.2, æ¶¨å¹…0-3%ï¼‰
    cond_ramp = (pool['vol_ratio'] >= 0.8) & (pool['vol_ratio'] <= 1.2) & (pool['pct_chg'] > 0) & (pool['pct_chg'] < 3.0)

    # ç»¼åˆå€™é€‰æ± 
    candidates = pool[cond_attack | cond_wash | cond_ramp]['ts_code'].tolist()
    return candidates
```

**æ•ˆæœ**ï¼š
- âœ… æ ·æœ¬åˆ†å¸ƒä¸å®ç›˜ä¸€è‡´
- âœ… AI å¯ä»¥å­¦ä¼šåŒºåˆ†"æ”¾é‡"ã€"ç¼©é‡"ã€"æ¢¯é‡"ä¸‰ç§å½¢æ€
- âœ… è®­ç»ƒå‡ºçš„æ¨¡å‹æœ‰å®ç”¨ä»·å€¼

---

## ğŸ“Š ä¿®å¤åçš„æµç¨‹

### å›æµ‹ç”Ÿæˆæµç¨‹

```
1. è·å–äº¤æ˜“æ—¥å†
   â†“
2. å¾ªç¯æ¯ä¸ªäº¤æ˜“æ—¥
   â†“
   2.1 åŠ è½½å½“æ—¥å…¨å¸‚åœºæ•°æ®ï¼ˆå†…å­˜ä¸­ï¼Œå¿«ï¼‰
   â†“
   2.2 ç­–ç•¥ç­›é€‰å€™é€‰è‚¡ï¼ˆçœŸå®ç­–ç•¥é€»è¾‘ï¼‰
   â”œâ”€ æ”¾é‡è¿›æ”»
   â”œâ”€ ç¼©é‡æ´—ç›˜
   â””â”€ æ¢¯é‡ä¸Šæ¶¨
   â†“
   2.3 å¯¹æ¯åªå€™é€‰è‚¡
   â”œâ”€ è·å–å†å²æ•°æ®ï¼ˆç”¨äºæå–ç‰¹å¾ Xï¼‰
   â”œâ”€ æå–ç‰¹å¾
   â”œâ”€ è·å–æœªæ¥æ•°æ®ï¼ˆç”¨äºè®¡ç®—æ ‡ç­¾ Yï¼‰
   â””â”€ è®¡ç®—æ ‡ç­¾ï¼ˆåŠ¨æ€æ­¢ç›ˆæ­¢æŸï¼‰
   â†“
3. è¿”å›è®­ç»ƒæ•°æ®ï¼ˆX, Yï¼‰
```

### æ ‡ç­¾è®¡ç®—æµç¨‹

```
1. è·å–æœªæ¥ N å¤©çš„æ•°æ®
   â†“
2. åŠ¨æ€æ­¢ç›ˆæ­¢æŸæ£€æŸ¥
   â”œâ”€ å¦‚æœæ”¶ç›Š <= æ­¢æŸï¼ˆ-5%ï¼‰â†’ æ ‡ç­¾ = 0
   â”œâ”€ å¦‚æœæ”¶ç›Š >= æ­¢ç›ˆï¼ˆ+3%ï¼‰â†’ æ ‡ç­¾ = 1
   â””â”€ æŒæœ‰åˆ°æœŸ â†’ æ ¹æ®æœ€ç»ˆæ”¶ç›Šåˆ¤æ–­
   â†“
3. è¿”å›æ ‡ç­¾
```

---

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### 1. æ˜ç¡®åŒºåˆ†å†å²æ•°æ®å’Œæœªæ¥æ•°æ®

```python
# å†å²æ•°æ®ï¼ˆç”¨äºæå–ç‰¹å¾ï¼‰
hist_df = self.warehouse.get_stock_data(ts_code, date, days=60)

# æœªæ¥æ•°æ®ï¼ˆç”¨äºè®¡ç®—æ ‡ç­¾ï¼‰
future_df = self._get_future_data(ts_code, date, self.hold_days)
```

### 2. åŠ¨æ€æ­¢ç›ˆæ­¢æŸ

```python
def calculate_label(self, future_df: pd.DataFrame, buy_price: float) -> int:
    """åŠ¨æ€æ­¢ç›ˆæ­¢æŸï¼Œè€Œä¸æ˜¯å‚»å‚»æŒæœ‰5å¤©"""
    for price in future_df['close_qfq']:
        pct_return = (price - buy_price) / buy_price * 100

        if pct_return <= self.stop_loss:  # æ­¢æŸ
            return 0
        if pct_return >= self.target_return:  # æ­¢ç›ˆ
            return 1

    # æŒæœ‰åˆ°æœŸ
    final_price = future_df.iloc[-1]['close_qfq']
    final_return = (final_price - buy_price) / buy_price * 100
    return 1 if final_return > 0 else 0
```

### 3. ç­–ç•¥å¤šæ ·åŒ–

æ”¯æŒä¸‰ç§å½¢æ€çš„æ ·æœ¬ï¼š
- **æ”¾é‡è¿›æ”»**ï¼šAI å­¦ä¼šè¿½æ¶¨
- **ç¼©é‡æ´—ç›˜**ï¼šAI å­¦ä¼šä½å¸
- **æ¢¯é‡ä¸Šæ¶¨**ï¼šAI å­¦ä¼šè¶‹åŠ¿è·Ÿè¸ª

---

## ğŸ“ˆ æ ·æœ¬åˆ†å¸ƒåˆ†æ

### ä¿®å¤å‰

| å½¢æ€ | æ¯”ä¾‹ | é—®é¢˜ |
|------|------|------|
| å¤§æ¶¨è‚¡ï¼ˆ>5%ï¼‰ | 100% | âŒ æ ·æœ¬å•ä¸€ |
| å…¶ä»–å½¢æ€ | 0% | âŒ æ— æ³•å­¦ä¹  |

### ä¿®å¤å

| å½¢æ€ | æ¯”ä¾‹ | è¯´æ˜ |
|------|------|------|
| æ”¾é‡è¿›æ”» | ~40% | âœ… è¿½æ¶¨é€»è¾‘ |
| ç¼©é‡æ´—ç›˜ | ~30% | âœ… ä½å¸é€»è¾‘ |
| æ¢¯é‡ä¸Šæ¶¨ | ~30% | âœ… è¶‹åŠ¿é€»è¾‘ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šæ•°æ®ç©¿è¶Šæ£€æŸ¥

```python
# ä¹°å…¥æ—¥æœŸ
buy_date = '20230115'

# è·å–å†å²æ•°æ®ï¼ˆT åŠä¹‹å‰ï¼‰
hist_df = warehouse.get_stock_data(ts_code, buy_date, days=60)
assert hist_df['trade_date'].max() <= buy_date  # âœ… é€šè¿‡

# è·å–æœªæ¥æ•°æ®ï¼ˆT ä¹‹åï¼‰
future_df = generator._get_future_data(ts_code, buy_date, 5)
assert future_df['trade_date'].min() > buy_date  # âœ… é€šè¿‡
```

### æµ‹è¯•2ï¼šæ ‡ç­¾å‡†ç¡®æ€§

```python
# æ¨¡æ‹Ÿæœªæ¥èµ°åŠ¿
future_prices = [10.0, 10.5, 11.0, 11.5, 12.0]
buy_price = 10.0

# ä¿®å¤å‰ï¼šå‚»å‚»æŒæœ‰5å¤©
label = (12.0 - 10.0) / 10.0 * 100 > 0  # True

# ä¿®å¤åï¼šåŠ¨æ€æ­¢ç›ˆæ­¢æŸ
for price in future_prices:
    pct = (price - buy_price) / buy_price * 100
    if pct >= 3.0:  # ç¬¬5å¤©è§¦å‘æ­¢ç›ˆ
        label = 1
        break
```

### æµ‹è¯•3ï¼šæ ·æœ¬åˆ†å¸ƒæ£€æŸ¥

```python
# ç”Ÿæˆè®­ç»ƒæ•°æ®
X, Y = generator.generate_training_data('20230101', '20230131')

# æ£€æŸ¥æ ·æœ¬æ¥æº
print(f"æ€»æ ·æœ¬æ•°: {len(X)}")
print(f"æ­£æ ·æœ¬: {Y.sum()}")
print(f"è´Ÿæ ·æœ¬: {len(Y) - Y.sum()}")

# æ£€æŸ¥èƒœç‡
win_rate = Y.sum() / len(Y) * 100
print(f"èƒœç‡: {win_rate:.2f}%")
```

---

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

### ç”Ÿæˆè®­ç»ƒæ•°æ®

```python
from ai_backtest_generator import AIBacktestGenerator

# åˆå§‹åŒ–
generator = AIBacktestGenerator()

# ç”Ÿæˆè®­ç»ƒæ•°æ®ï¼ˆå»ºè®®å…ˆæµ‹è¯•å°èŒƒå›´ï¼‰
X, Y = generator.generate_training_data(
    start_date='20230101',
    end_date='20231231',
    max_samples=None  # ä¸é™åˆ¶æ ·æœ¬æ•°
)

# ä¿å­˜è®­ç»ƒæ•°æ®
generator.save_training_data(X, Y)
```

### å‚æ•°é…ç½®

```python
generator.hold_days = 5          # æŒæœ‰å¤©æ•°
generator.target_return = 3.0    # ç›®æ ‡æ”¶ç›Šï¼ˆ%ï¼‰
generator.stop_loss = -5.0       # æ­¢æŸï¼ˆ%ï¼‰
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®å‡†å¤‡

- **å¿…é¡»å…ˆä¸‹è½½æ•°æ®**ï¼šä½¿ç”¨ `data_warehouse.py` ä¸‹è½½å†å²æ•°æ®
- **æ•°æ®å¿…é¡»åŒ…å«å¤æƒå› å­**ï¼šç¡®ä¿æ ‡ç­¾è®¡ç®—å‡†ç¡®
- **æ•°æ®é•¿åº¦è¦æ±‚**ï¼šè‡³å°‘éœ€è¦ `hold_days + 30` å¤©çš„æ•°æ®

### 2. æ ·æœ¬åˆ†å¸ƒ

- **æ ·æœ¬é‡**ï¼šå»ºè®®è‡³å°‘ 10,000 ä¸ªæ ·æœ¬
- **æ­£è´Ÿæ ·æœ¬æ¯”**ï¼šç›®æ ‡ 1:1ï¼ˆé€šè¿‡ç­–ç•¥ç­›é€‰å®ç°ï¼‰
- **æ—¶é—´è·¨åº¦**ï¼šå»ºè®®è‡³å°‘ 1 å¹´çš„æ•°æ®

### 3. æ€§èƒ½ä¼˜åŒ–

- **æ•°æ®å­˜å‚¨**ï¼šå»ºè®®ä½¿ç”¨ HDF5/Parquet æ›¿ä»£ CSV
- **å†…å­˜ç¼“å­˜**ï¼šå¯ä»¥å°†æœ€è¿‘ N å¤©çš„æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­
- **å¹¶è¡Œå¤„ç†**ï¼šå¯ä»¥ä½¿ç”¨å¤šè¿›ç¨‹åŠ é€Ÿç‰¹å¾æå–

---

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®å­˜å‚¨ä¼˜åŒ–

```python
# ä½¿ç”¨ HDF5 å­˜å‚¨æ•°æ®ï¼ˆæ›´å¿«çš„è¯»å–é€Ÿåº¦ï¼‰
import h5py

# æˆ–ä½¿ç”¨ Parquetï¼ˆæ›´å¥½çš„å‹ç¼©æ¯”ï¼‰
df.to_parquet('data.parquet')
```

### 2. å¹¶è¡Œå¤„ç†

```python
from multiprocessing import Pool

def extract_features_for_stock(ts_code):
    hist_df = warehouse.get_stock_data(ts_code, date, days=60)
    return extractor.extract_features(hist_df)

with Pool(processes=4) as pool:
    results = pool.map(extract_features_for_stock, candidates)
```

### 3. å¢é‡æ›´æ–°

```python
# åªæ›´æ–°æœ€è¿‘çš„æ•°æ®ï¼Œé¿å…é‡å¤å¤„ç†
if os.path.exists('train_data.csv'):
    old_df = pd.read_csv('train_data.csv')
    last_date = old_df['trade_date'].max()
    new_X, new_Y = generator.generate_training_data(last_date, today)
    # åˆå¹¶æ–°æ—§æ•°æ®
```

---

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼Œè§£å†³äº†ä¸‰ä¸ªè‡´å‘½é—®é¢˜ï¼š

1. âœ… **ä¿®å¤æ•°æ®ç©¿è¶Š**ï¼šæ­£ç¡®è·å–æœªæ¥æ•°æ®ï¼Œæ ‡ç­¾è®¡ç®—å‡†ç¡®
2. âœ… **æå‡æ€§èƒ½**ï¼šä¼˜åŒ–æ•°æ®è¯»å–ï¼Œå‡å°‘é”™è¯¯ä¸­æ–­
3. âœ… **æ ·æœ¬åˆ†å¸ƒä¸€è‡´**ï¼šå¤åˆ»çœŸå®ç­–ç•¥é€»è¾‘ï¼Œæ¨¡å‹æœ‰å®ç”¨ä»·å€¼

è¿™äº›ä¼˜åŒ–ç¡®ä¿äº† AI è£åˆ¤ç³»ç»Ÿçš„è®­ç»ƒæ•°æ®æ˜¯å‡†ç¡®ã€é«˜æ•ˆã€ä¸å®ç›˜ä¸€è‡´çš„ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æ›´æ–°æ—¥æœŸ**ï¼š2025-01-29
**ä½œè€…**ï¼šDeepQuant Team
