# V5.0 优化总结报告

## 优化目标
融合参考代码的优点，创建一个更稳健的 V5.0 版本。

---

## 核心优化点

### 1. 添加 V5.0 参数
```python
self.bear_threshold = -2.0    # 熊市判定阈值（大盘跌幅 < -2%）
self.alpha_threshold = 3.0    # 超额收益目标（%）
self.amount_threshold = 1000  # 成交额阈值（千元）
self.vol_ratio_attack_min = 1.2   # 放量进攻最小量比
self.vol_ratio_wash_max = 1.0     # 缩量洗盘最大量比
```

### 2. 优化候选股票筛选
**问题**：参考代码使用了不存在的 `name` 列
**修复**：使用 `ts_code` 过滤 ST 股票

**改进**：
- 当 `vol_ratio` 不存在时，使用成交量分位值计算量比
- 明确区分"放量进攻"和"缩量洗盘"两种形态

### 3. 添加便捷方法 `generate_dataset`
**优点**：一步生成完整数据集（特征+标签），方便测试

### 4. 修复除零错误
**问题**：当样本数为 0 时，`Y.sum()/len(Y)` 会报错
**修复**：添加 `if len(X) > 0` 检查

---

## 测试结果

### 2024年1月22日（千股跌停日）
```
总股票数: 5,261
V5.0 筛选候选股票数: 284
筛选比例: 5.4%
```

**说明**：
- 在极端行情下，V5.0 仍能筛选出 284 只候选股票
- 筛选比例合理（5.4%），既不会太宽（太多噪音），也不会太窄（错过机会）

---

## 已实现的功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 相对收益标签 | ✅ 已实现 | 熊市中使用超额收益 |
| 样本加权 | ✅ 已实现 | 动态计算 scale_pos_weight |
| 复权处理 | ✅ 已实现 | 优先使用 close_qfq |
| 百分比斜率 | ✅ 已实现 | pct_change() * 100 |
| 归一化位置 | ✅ 已实现 | position_20d, position_250d |
| 便捷方法 | ✅ 已实现 | generate_dataset() |
| 参数可配置 | ✅ 已实现 | 所有阈值都可调整 |

---

## 参考代码 vs 当前实现对比

| 项目 | 参考代码 | 当前实现 | 评价 |
|------|---------|---------|------|
| ST 过滤 | `name.str.contains('ST')` ❌ | `ts_code.str.contains('ST\|退')` ✅ | 当前实现更稳健 |
| 成交额阈值 | `> 30000`（3亿） | `> 1000`（0.1亿） | 当前实现更宽松 |
| 量比计算 | 假设存在 | 动态计算 | 当前实现更健壮 |
| 标签计算 | 只看最终收益 | 动态止盈止损 | 当前实现更贴近实盘 |
| 数据生成 | `generate_dataset` | `generate_training_data` + `generate_dataset` | 当前实现更灵活 |

---

## 数据问题（非代码问题）

### 当前数据情况
- 数据仓库中只有 2024年1月的数据（20240102-20240131）
- 历史数据最多 22 天，无法满足 `days=60` 的要求
- 导致特征提取失败（需要至少 30 天历史数据）

### 解决方案
1. **下载更多历史数据**：使用 `download_2024_data.py` 下载 2023-2024 年数据
2. **调整参数**：临时降低历史数据要求（`days=30`）

---

## 使用建议

### 1. 训练数据生成
```python
from ai_backtest_generator import AIBacktestGenerator

generator = AIBacktestGenerator()

# 方法 1：生成完整数据集（推荐）
df = generator.generate_dataset('20230101', '20231231')

# 方法 2：生成 X, Y 分离数据
X, Y = generator.generate_training_data('20230101', '20231231')
```

### 2. 参数调整
```python
generator.bear_threshold = -3.0    # 调整熊市阈值
generator.alpha_threshold = 5.0    # 调整超额收益目标
generator.amount_threshold = 3000  # 调整成交额阈值（更严格）
```

### 3. 训练模型
```python
from ai_referee import AIReferee

referee = AIReferee(model_type='xgboost')
referee.train_time_series(X, Y, n_splits=5)  # 自动计算 scale_pos_weight
```

---

## 下一步行动

1. **下载历史数据**：确保有足够的历史数据（至少 60 天）
2. **生成训练数据**：使用 2023-2024 年数据
3. **训练模型**：使用 `train_time_series` 方法
4. **验证效果**：检查正样本占比、scale_pos_weight 等指标

---

## 版本信息
- **版本**：V5.0
- **状态**：✅ 代码优化完成，等待数据补充
- **文件**：
  - `ai_backtest_generator.py`（已优化）
  - `AI_REFEREE_V5.0_OPTIMIZATION_SUMMARY.md`（优化总结）
  - `AI_REFEREE_V5.0_COMPARISON.md`（对比分析）
  - `test_v5_quick.py`（快速测试）
