# 🏦 自动提款机模式使用指南 V2

## 📊 核心理念

**从"选股雷达"到"自动提款机"的转变**

| 指标 | 选股雷达（默认） | 自动提款机（优化后） | 提升幅度 |
|------|----------------|-------------------|---------|
| 阈值 | 0.5 | **0.6499** | +30% |
| 精确率 | 26.57% | **62.50%** | **+135% (2.35倍)** |
| 召回率 | 77.21% | 1.98% | -97% |
| 选股数量 | 200只 → 约53只 | 200只 → **约2只** | 精准狙击 |

**关键成果**: 每买 10 只股票，从 2 只大涨提升到 **6 只大涨**！

---

## 🎯 为什么需要阈值优化？

### 原来的问题

由于模型使用了 4.6 倍的 `scale_pos_weight`，模型为了不漏掉任何一个机会，把很多"虽然长得像机会，但其实是坑"的股票都选进来了（概率可能在 0.55 左右）。

### 解决方案

通过 PR 曲线分析，找到精确率 60% 的最佳阈值（0.6499），过滤掉"噪音区"，只保留"确信区"的股票。

### 概率区间解读

| 概率区间 | 含义 | 操作建议 |
|---------|------|---------|
| 0.00 - 0.50 | **无效区** | 无上涨信号，直接放弃 |
| 0.50 - 0.65 | **噪音区** | 似是而非，试盘为主，**不操作** |
| 0.65 - 0.75 | **观察区** | 有一定机会，但风险较高，**谨慎观察** |
| 0.75 - 0.85 | **确信区** | 主力明确，技术共振，**重点关注** |
| 0.85 - 0.90 | **强区** | 信号强烈，成功率高，**可考虑** |
| 0.90 - 1.00 | **真龙区** | 极高置信度，⭐标记，**重点狙击** |

---

## 🚀 快速开始

### 第一步：寻找黄金阈值（每月执行一次）

```bash
python3 scripts/optimize_threshold.py
```

**功能**：
- 加载训练好的模型
- 获取最近 2 个月验证数据
- 计算 PR 曲线
- 找到精确率 60% 的最佳阈值
- 自动生成配置文件

**输出**：
- 配置文件：`config/atm_strategy_config.json`
- 日志文件：`assets/threshold_optimization.log`

**执行频率**：每月执行一次（或市场剧烈波动后）

---

### 第二步：每日提款（每日收盘后执行）

```bash
python3 scripts/daily_prediction.py
```

**功能**：
- 加载模型和优化后的阈值
- 获取股票池（200 只）
- 进行特征工程
- 预测概率
- 筛选置信度 ≥ 阈值的股票
- 输出详细信息（主力净流、换手率等）

**输出**：
- 控制台输出（实时进度 + 结果表格）
- CSV 文件：`assets/atm_prediction_YYYYMMDD.csv`
- 日志文件：`assets/atm_prediction.log`

**执行频率**：每日收盘后执行

---

## 📊 输出结果解读

### 示例输出

```
🔍 原始推荐数: 186
🦁 过滤后真龙数: 2 (过滤率: 98.92%)

🏆 今日【自动提款机】精选推荐:
================================================================================
代码         日期         现价       上涨概率       主力净流         换手率
--------------------------------------------------------------------------------
001316.SZ  20260130 51.02    0.7009     2920.00      7.39    %
301073.SZ  20260130 30.26    0.6693     6020.00      9.73    %
================================================================================
```

### 字段说明

| 字段 | 含义 | 解读 |
|------|------|------|
| **代码** | 股票代码 | 交易所 + 股票编号 |
| **日期** | 最新交易日 | 确认数据新鲜度 |
| **现价** | 收盘价 | 当前股价，用于开仓参考 |
| **上涨概率** | 模型预测概率 | ≥ 阈值（0.6499）才推荐 |
| **主力净流** | 主力资金净流入（万元） | 正值表示主力流入，越大越好 |
| **换手率** | 日换手率（%） | 5-15% 为最佳，过高需谨慎 |

### ⭐ 标记说明

如果股票概率 > 0.90，会显示 ⭐ 标记，表示"真龙区"股票，极高置信度。

---

## 💰 主力资金分析

### 主力净流入解读

| 主力净流入 | 状态 | 操作建议 |
|-----------|------|---------|
| < 0 | 主力流出 | 即使概率高也要谨慎 |
| 0 - 1000 | 微流入 | 观望为主 |
| 1000 - 3000 | 明显流入 | 可以考虑 |
| 3000 - 5000 | 强流入 | 重点关注 |
| > 5000 | 超强流入 | 重点狙击 ⭐ |

### 示例分析

**301073.SZ**：
- 主力净流入：6020 万（超强流入）
- 换手率：9.73%（活跃度适中）
- 概率：0.6693（确信区）
- **结论**：主力强势介入，可重点考虑

---

## 📈 换手率分析

### 换手率区间

| 换手率 | 状态 | 含义 |
|--------|------|------|
| < 3% | 低迷 | 无人关注，难有大行情 |
| 3% - 5% | 温和 | 适度关注 |
| 5% - 10% | 活跃 | 主力活跃，最佳区间 |
| 10% - 15% | 热门 | 关注度高，注意风险 |
| 15% - 25% | 爆发 | 可能是最后一棒，谨慎 |
| > 25% | 疯狂 | 风险极大，建议回避 |

### 最佳组合

**黄金三角**：
- 概率 ≥ 0.75
- 主力净流入 ≥ 3000 万
- 换手率 5-10%

---

## ⚠️ 操盘建议

### 买入策略

1. **优先级排序**：
   - 第一优先：概率 > 0.90（⭐真龙区）
   - 第二优先：概率 0.85-0.90（强区）
   - 第三优先：概率 0.75-0.85（确信区）

2. **分批建仓**：
   - 不要一次性满仓
   - 建议 2-3 次分批买入
   - 第一次买入 30%，确认趋势后再加仓

3. **K线确认**：
   - 即使概率高，也要看K线形态
   - 剔除处于明显下降通道的股票
   - 优选均线多头排列的股票

### 止损策略

| 情况 | 止损点 | 原因 |
|------|--------|------|
| 亏损 > 5% | 立即止损 | 防止大亏 |
| 跌破重要支撑位 | 立即止损 | 技术破位 |
| 主力大幅流出 | 立即止损 | 资金撤离 |
| 连续 3 日无涨幅 | 止损离场 | 时间止损 |

### 止盈策略

| 情况 | 止盈点 | 操作 |
|------|--------|------|
| 涨幅 > 8% | 部分止盈 | 卖出 50% |
| 涨幅 > 15% | 全部止盈 | 落袋为安 |
| 量能萎缩 | 考虑止盈 | 筹码松动 |
| 概率信号消失 | 止盈离场 | 信号失效 |

### 仓位管理

| 总资金 | 单只股票 | 股票数量 |
|--------|----------|----------|
| 10 万 | ≤ 1 万 | 2-3 只 |
| 50 万 | ≤ 2.5 万 | 3-5 只 |
| 100 万 | ≤ 5 万 | 3-5 只 |
| 500 万+ | ≤ 25 万 | 5-10 只 |

---

## 🔍 实战案例

### 案例 1：真龙区股票（概率 > 0.90）

**假设数据**：
- 代码：601888.SH
- 概率：0.9234 ⭐
- 主力净流入：8500 万
- 换手率：6.8%
- 现价：25.50

**操作建议**：
- ✅ 极高置信度，重点关注
- ✅ 主力超强流入，资金驱动明显
- ✅ 换手率适中，活跃度好
- ✅ 建议仓位：4-5%（单只上限）
- ✅ 止损：-5%
- ✅ 止盈：+10%（分批）

### 案例 2：确信区股票（概率 0.75-0.85）

**假设数据**：
- 代码：002915.SZ
- 概率：0.8123
- 主力净流入：4200 万
- 换手率：8.5%
- 现价：18.20

**操作建议**：
- ✅ 信号明确，可以考虑
- ✅ 主力明显流入
- ✅ 换手率适中
- ✅ 建议仓位：3-4%
- ✅ 止损：-5%
- ✅ 止盈：+8%（一次性）

### 案例 3：观察区股票（概率 0.65-0.75）

**假设数据**：
- 代码：603727.SH
- 概率：0.7035
- 主力净流入：1800 万
- 换手率：5.2%
- 现价：32.80

**操作建议**：
- ⚠️ 概率在阈值附近，不够强
- ⚠️ 主力流入一般
- ✅ 换手率适中
- ⚠️ 建议观察，不建议立即买入
- ⚠️ 如果有更优质的股票，优先选择其他

---

## 📋 维护清单

### 每日任务

- [ ] 运行 `daily_prediction.py` 获取推荐股票
- [ ] 分析主力净流入和换手率
- [ ] 结合K线形态确认
- [ ] 更新交易日志
- [ ] 监控持仓股票表现

### 每周任务

- [ ] 统计本周胜率（目标 ≥ 60%）
- [ ] 分析失败案例（止损原因）
- [ ] 调整仓位策略
- [ ] 检查模型性能（精确率是否下降）

### 每月任务

- [ ] 运行 `optimize_threshold.py` 重新优化阈值
- [ ] 回测验证策略表现
- [ ] 检查数据完整性（资金流、复权因子）
- [ ] 评估是否需要重新训练模型

### 每季任务

- [ ] 重新训练模型（市场结构变化时）
- [ ] 评估策略有效性
- [ ] 调整特征工程（新增/删除特征）
- [ ] 更新训练配置

---

## ⚡ 故障排查

### 问题 1：没有推荐股票

**原因分析**：
- 当前市场机会较少
- 阈值设置过高
- 数据获取失败

**解决方案**：
1. 检查数据是否完整
2. 确认阈值是否合理
3. 空仓观望，等待更好时机

### 问题 2：推荐股票过多（>10只）

**原因分析**：
- 阈值设置过低
- 市场过热（风险高）

**解决方案**：
1. 运行 `optimize_threshold.py` 重新计算阈值
2. 手动提高阈值（如从 0.65 提高到 0.75）
3. 严格筛选主力净流入和换手率

### 问题 3：连续多日亏损

**原因分析**：
- 模型失效（市场环境变化）
- 策略参数不合理
- 操作失误

**解决方案**：
1. 暂停实盘，观察 1-2 周
2. 重新优化阈值
3. 检查是否需要重新训练模型
4. 复盘操作记录，找出问题

---

## 📊 性能监控

### 关键指标

| 指标 | 当前值 | 目标值 | 监控频率 |
|------|--------|--------|---------|
| 精确率 | 62.50% | ≥ 60% | 每周 |
| 召回率 | 1.98% | ≥ 1% | 每月 |
| 阈值 | 0.6499 | 0.6-0.8 | 每月 |
| 胜率 | 待统计 | ≥ 60% | 每周 |
| 平均收益 | 待统计 | ≥ 8% | 每月 |

### 性能下降处理流程

```
发现性能下降
    ↓
检查数据完整性
    ↓
运行 optimize_threshold.py
    ↓
重新测试
    ↓
如果仍未改善 → 考虑重新训练模型
```

---

## 🔧 配置文件说明

### config/atm_strategy_config.json

```json
{
    "model_path": "/workspace/projects/assets/models/主力资金驱动-高置信度策略_model.pkl",
    "prediction_threshold": 0.6498849987983704,
    "expected_precision": 0.625,
    "updated_at": "2026-02-01 00:37:39"
}
```

**字段说明**：
- `model_path`：模型文件路径
- `prediction_threshold`：最佳阈值（自动计算，勿手动修改）
- `expected_precision`：预期精确率
- `updated_at`：上次更新时间

---

## 📞 技术支持

### 核心脚本

- 训练模型：`scripts/train_auto_optuna.py`
- 阈值优化：`scripts/optimize_threshold.py`
- 日常选股：`scripts/daily_prediction.py`

### 配置文件

- 模型配置：`config/precision_priority_v4_config.json`
- ATM 配置：`config/atm_strategy_config.json`
- Tushare 配置：`config/tushare_config.json`

### 输出文件

- 阈值优化日志：`assets/threshold_optimization.log`
- 每日选股结果：`assets/atm_prediction_YYYYMMDD.csv`
- 每日选股日志：`assets/atm_prediction.log`

---

## ⚠️ 免责声明

本策略仅供学习研究使用，不构成投资建议。

**风险提示**：
1. 股市有风险，投资需谨慎
2. 本策略基于历史数据训练，不保证未来收益
3. 建议结合基本面分析和市场情绪
4. 严格控制仓位，合理止损
5. 当前精确率 62.5%，仍有约 37.5% 的失败概率

---

## 📝 版本信息

- **模式名称**：自动提款机（ATM Strategy）
- **版本**：V5.2.0
- **更新日期**：2026-02-01
- **模型**：XGBoost 3.1.3 + Optuna 4.7.0
- **精确率**：62.50%
- **召回率**：1.98%
- **最佳阈值**：0.6499

---

**总结**: 自动提款机模式通过阈值优化，将精确率提升至 62.5%，实现精准狙击策略。建议每日收盘后运行，严格控制仓位和止损，保持理性投资！
