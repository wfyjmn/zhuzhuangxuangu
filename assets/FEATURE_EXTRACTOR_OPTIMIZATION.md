# FeatureExtractor ä¼˜åŒ–è¯´æ˜æ–‡æ¡£

## æ¦‚è¿°

é’ˆå¯¹ `feature_extractor.py` ä¸­çš„å››ä¸ªå…³é”®é—®é¢˜è¿›è¡Œäº†ä¸“ä¸šçº§ä¼˜åŒ–ä¿®å¤ï¼Œç¡®ä¿æå–çš„ç‰¹å¾é€‚åˆæœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒã€‚

---

## ğŸš¨ ä¿®å¤çš„å…³é”®é—®é¢˜

### 1. å‡çº¿æ–œç‡æœªå½’ä¸€åŒ–ï¼ˆæœ€ä¸¥é‡é—®é¢˜ï¼‰

**é—®é¢˜æè¿°**ï¼š
åŸä»£ç ä½¿ç”¨ç»å¯¹ä»·æ ¼å˜åŒ–è®¡ç®—æ–œç‡ï¼š
```python
# åŸä»£ç ï¼ˆé”™è¯¯ï¼‰
latest['ma5'] - df.iloc[-2]['ma5']
```

**åæœ**ï¼š
- é«˜ä»·è‚¡ï¼ˆèŒ…å° 1500å…ƒï¼‰çš„ MA5 ä¸€å¤©å¯èƒ½å˜åŠ¨ 30å…ƒ
- ä½ä»·è‚¡ï¼ˆå·¥è¡Œ 5å…ƒï¼‰çš„ MA5 ä¸€å¤©å¯èƒ½å˜åŠ¨ 0.05å…ƒ
- AI ä¼šè®¤ä¸ºèŒ…å°çš„è¶‹åŠ¿å¼ºåº¦æ˜¯å·¥è¡Œçš„ **600å€**ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨ç™¾åˆ†æ¯”æ–œç‡ï¼š
```python
# ä¼˜åŒ–åï¼ˆæ­£ç¡®ï¼‰
df['ma5'].pct_change() * 100
```

**æ•ˆæœ**ï¼š
ç°åœ¨ï¼Œæ— è®ºè‚¡ä»·æ˜¯ 1000å…ƒ è¿˜æ˜¯ 2å…ƒï¼Œåªè¦å‡çº¿ç¿˜å¤´çš„è§’åº¦ä¸€æ ·ï¼Œå¾—å‡ºçš„ç‰¹å¾å€¼å°±æ˜¯ä¸€æ ·çš„ï¼ˆæ¯”å¦‚éƒ½æ˜¯ +1.5%ï¼‰ã€‚è¿™è®© AI æ¨¡å‹å¯ä»¥è·¨è‚¡ç¥¨å­¦ä¹ è§„å¾‹ã€‚

---

### 2. RSI é™¤é›¶é£é™©

**é—®é¢˜æè¿°**ï¼š
åŸä»£ç ï¼š
```python
# åŸä»£ç ï¼ˆæœ‰é£é™©ï¼‰
rs = gain / loss
```

**åæœ**ï¼š
å¦‚æœæŸåªè‚¡ç¥¨è¿ç»­14å¤©ä¸Šæ¶¨ï¼Œ`loss` ä¸º 0ï¼Œç¨‹åºä¼šæŠ¥é”™æˆ–äº§ç”Ÿ `inf`ï¼ˆæ— ç©·å¤§ï¼‰ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
å¢åŠ é™¤é›¶ä¿æŠ¤ï¼š
```python
# ä¼˜åŒ–åï¼ˆå®‰å…¨ï¼‰
rs = gain / (loss + 1e-9)  # é¿å…é™¤é›¶
```

---

### 3. å½’ä¸€åŒ–æ–¹æ³•å¤ªç²—æš´

**é—®é¢˜æè¿°**ï¼š
åŸä»£ç ç¡¬ç¼–ç ï¼š
```python
# åŸä»£ç ï¼ˆç²—æš´ï¼‰
value / 10
```

**åæœ**ï¼š
ä¸åŒç‰¹å¾çš„é‡çº²å®Œå…¨ä¸åŒï¼š
- PE æ˜¯ 0-100
- æ¢æ‰‹ç‡æ˜¯ 0-20
- æ¶¨è·Œå¹…æ˜¯ -10 åˆ° 10

ç®€å•çš„é™¤ä»¥10ä¼šè®©æŸäº›ç‰¹å¾å¤±æ•ˆã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
**åˆ é™¤å½’ä¸€åŒ–æ¨¡å—**ï¼Œä¿ç•™åŸå§‹ç‰¹å¾ï¼š

**åŸå› **ï¼š
- **XGBoost/LightGBM** ç­‰æ ‘æ¨¡å‹ä¸éœ€è¦å½’ä¸€åŒ–ï¼ˆå®ƒä»¬å¯¹æ•°å€¼å¤§å°ä¸æ•æ„Ÿï¼Œåªçœ‹æ’åºï¼‰
- ä¿ç•™åŸå§‹ç‰©ç†å«ä¹‰ï¼ˆå¦‚ PE=50ï¼‰æ›´æœ‰åˆ©äºå¯è§£é‡Šæ€§
- å¦‚æœæ˜¯ç¥ç»ç½‘ç»œï¼Œå¯ä»¥åœ¨è®­ç»ƒç®¡é“ï¼ˆPipelineï¼‰é‡ŒåŠ  `StandardScaler`ï¼Œä¸è¦å†™æ­»åœ¨æå–å™¨é‡Œ

---

### 4. ç¼ºå°‘"æ³¢åŠ¨ç‡"å’Œ"ç›¸å¯¹ä½ç½®"ç‰¹å¾

**é—®é¢˜æè¿°**ï¼š
DeepQuant çš„ç­–ç•¥ï¼ˆæ´—ç›˜ã€å¼ºæ”»ï¼‰éå¸¸ä¾èµ–å½“å‰ä»·æ ¼åœ¨è¿‡å»ä¸€æ®µæ—¶é—´çš„ä½ç½®ï¼ˆé«˜ä½è¿˜æ˜¯ä½ä½ï¼‰ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
å¢åŠ ä¸¤ä¸ªå…³é”®ç‰¹å¾ï¼š

```python
# 1. ç›¸å¯¹ä½ç½® (Position)
# å½“å‰ä»·åœ¨è¿‡å» N å¤©çš„ç›¸å¯¹ä½ç½®ï¼ˆ0-1ï¼‰
# 0 = æœ€ä½ç‚¹, 1 = æœ€é«˜ç‚¹
df['position_20d'] = (price - low_20) / (high_20 - low_20 + 1e-9)
df['position_250d'] = (price - low_250) / (high_250 - low_250 + 1e-9)

# 2. æ³¢åŠ¨ç‡ (Volatility)
# è¡¡é‡è‚¡ä»·çš„æ³¢åŠ¨ç¨‹åº¦
df['std_20_ratio'] = price.rolling(20).std() / df['ma20'] * 100
```

**åº”ç”¨åœºæ™¯**ï¼š
- `position_20d`ï¼ˆçŸ­æœŸä½ç½®ï¼‰ï¼šæ´—ç›˜ç­–ç•¥é€šå¸¸è¦æ±‚è¿™ä¸ªå€¼è¾ƒä½ï¼ˆå›è°ƒï¼‰
- `position_250d`ï¼ˆé•¿æœŸä½ç½®ï¼‰ï¼šå¼ºæ”»ç­–ç•¥é€šå¸¸å–œæ¬¢è¿™ä¸ªå€¼æ¥è¿‘ 1.0ï¼ˆçªç ´å¹´çº¿æ–°é«˜ï¼‰
- è¿™ä¸¤ä¸ªç‰¹å¾å¯¹ AI åˆ¤æ–­è‚¡ç¥¨æ‰€å¤„é˜¶æ®µï¼ˆå¸ç­¹ã€æ‹‰å‡ã€å‡ºè´§ï¼‰éå¸¸æœ‰å¸®åŠ©

---

## ğŸ“Š ä¼˜åŒ–åçš„ç‰¹å¾åˆ—è¡¨ï¼ˆ24ä¸ªï¼‰

### åŸºç¡€é‡ä»·ï¼ˆ3ä¸ªï¼‰
- `vol_ratio`ï¼šé‡æ¯”
- `turnover_rate`ï¼šæ¢æ‰‹ç‡
- `pe_ttm`ï¼šå¸‚ç›ˆç‡ï¼ˆTTMï¼‰

### è¶‹åŠ¿ç‰¹å¾ï¼ˆ5ä¸ªï¼‰
- `pct_chg_1d`ï¼š1æ—¥æ¶¨è·Œå¹…ï¼ˆåŠ¨é‡ï¼‰
- `pct_chg_5d`ï¼š5æ—¥æ¶¨è·Œå¹…
- `pct_chg_20d`ï¼š20æ—¥æ¶¨è·Œå¹…
- `ma5_slope`ï¼š5æ—¥å‡çº¿æ–œç‡(%) â­ ä¿®å¤ä¸ºç™¾åˆ†æ¯”
- `ma20_slope`ï¼š20æ—¥å‡çº¿æ–œç‡(%) â­ ä¿®å¤ä¸ºç™¾åˆ†æ¯”

### åç¦»ç‰¹å¾ï¼ˆ2ä¸ªï¼‰
- `bias_5`ï¼š5æ—¥ä¹–ç¦»ç‡
- `bias_20`ï¼š20æ—¥ä¹–ç¦»ç‡

### éœ‡è¡ç‰¹å¾ï¼ˆ2ä¸ªï¼‰
- `rsi_14`ï¼šRSIæŒ‡æ ‡ï¼ˆ14å‘¨æœŸï¼‰â­ ä¿®å¤é™¤é›¶é£é™©
- `std_20_ratio`ï¼š20æ—¥æ ‡å‡†å·®/å‡ä»·ï¼ˆæ³¢åŠ¨ç‡ï¼‰â­ æ–°å¢

### ç›¸å¯¹ä½ç½®ï¼ˆ2ä¸ªï¼‰â­ æ–°å¢
- `position_20d`ï¼šå½“å‰ä»·åœ¨è¿‘20å¤©çš„ä½ç½®(0-1)
- `position_250d`ï¼šå½“å‰ä»·åœ¨å¹´çº¿çš„ä½ç½®(0-1)

### MACDï¼ˆ3ä¸ªï¼‰
- `macd_dif`ï¼šMACD DIF
- `macd_dea`ï¼šMACD DEA
- `macd_hist`ï¼šMACD çº¢ç»¿æŸ±

### ç¯å¢ƒç‰¹å¾ï¼ˆ2ä¸ªï¼‰
- `index_pct_chg`ï¼šå¤§ç›˜æ¶¨è·Œå¹…
- `sector_pct_chg`ï¼šæ¿å—æ¶¨è·Œå¹…

### è¯„åˆ†ç³»ç»Ÿï¼ˆ3ä¸ªï¼‰
- `moneyflow_score`ï¼šèµ„é‡‘æµå¾—åˆ†
- `tech_score`ï¼šæŠ€æœ¯å½¢æ€å¾—åˆ†
- `new_score`ï¼šç»¼åˆè¯„åˆ†

---

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### 1. è‡ªåŠ¨è·¯ç”±å¤æƒä»·

```python
def _get_price_col(self, df: pd.DataFrame) -> str:
    """è‡ªåŠ¨åˆ¤æ–­ä½¿ç”¨å¤æƒä»·è¿˜æ˜¯æ”¶ç›˜ä»·"""
    if 'close_qfq' in df.columns:
        return 'close_qfq'
    return 'close'
```

**ä¼˜åŠ¿**ï¼š
- å¦‚æœ DataWarehouse è¾“å‡ºçš„æ•°æ®æœ‰ `close_qfq`ï¼Œå°±ç”¨å®ƒ
- å¦‚æœæ²¡æœ‰ï¼ˆæ¯”å¦‚å›æµ‹åˆšä¸Šå¸‚çš„æ–°è‚¡ï¼‰ï¼Œå°±é™çº§ä½¿ç”¨ `close`
- ä¿è¯äº†é€»è¾‘çš„å¥å£®æ€§

### 2. å‘é‡åŒ–è®¡ç®—

```python
def calculate_indicators(self, df: pd.DataFrame) -> pd.DataFrame:
    """ä¸€æ¬¡æ€§è®¡ç®—æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡ï¼ˆå‘é‡åŒ–åŠ é€Ÿï¼‰"""
    # æ‰€æœ‰æŒ‡æ ‡ä¸€æ¬¡æ€§è®¡ç®—ï¼Œé¿å…é‡å¤éå†
    df['ma5'] = price.rolling(window=5).mean()
    df['bias_5'] = (price - df['ma5']) / df['ma5'] * 100
    df['ma5_slope'] = df['ma5'].pct_change() * 100
    # ...
```

**ä¼˜åŠ¿**ï¼š
- ä¸€æ¬¡æ€§è®¡ç®—æ‰€æœ‰æŒ‡æ ‡
- åˆ©ç”¨ Pandas å‘é‡åŒ–æ“ä½œï¼Œé€Ÿåº¦æ›´å¿«
- é¿å…é‡å¤éå†æ•°æ®

### 3. å¥å£®æ€§å¢å¼º

```python
# å¤„ç† NaN å’Œ inf
val = latest.get(col, 0)
features[col] = 0 if (pd.isna(val) or np.isinf(val)) else val

# ç¡®ä¿æ•°æ®é•¿åº¦è¶³å¤Ÿ
if len(df) < 30:
    return {k: 0 for k in self.feature_names}
```

**ä¼˜åŠ¿**ï¼š
- åˆšä¸Šå¸‚æˆ–åœç‰Œçš„è‚¡ç¥¨ä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ
- è¿”å›å…¨0ç‰¹å¾ï¼Œè€Œä¸æ˜¯æŠ¥é”™
- ä¿è¯å›æµ‹æµç¨‹çš„è¿ç»­æ€§

---

## ğŸ“ˆ å¯¹AIæ¨¡å‹çš„æ”¹è¿›

### 1. ç‰¹å¾å¯è§£é‡Šæ€§å¢å¼º

**ä¿®å¤å‰**ï¼š
```
ma5_slope: 30.0  # èŒ…å°ï¼ˆç»å¯¹å€¼ï¼Œæ— æ³•æ¯”è¾ƒï¼‰
ma5_slope: 0.05  # å·¥è¡Œï¼ˆç»å¯¹å€¼ï¼Œæ— æ³•æ¯”è¾ƒï¼‰
```

**ä¿®å¤å**ï¼š
```
ma5_slope: 1.5  # èŒ…å°ï¼ˆç™¾åˆ†æ¯”ï¼Œå¯æ¯”è¾ƒï¼‰
ma5_slope: 1.0  # å·¥è¡Œï¼ˆç™¾åˆ†æ¯”ï¼Œå¯æ¯”è¾ƒï¼‰
```

ç°åœ¨ AI å¯ä»¥æ­£ç¡®åˆ¤æ–­ï¼šèŒ…å°å’Œå·¥è¡Œçš„è¶‹åŠ¿å¼ºåº¦ç›¸è¿‘ã€‚

### 2. ç‰¹å¾ä¿¡æ¯é‡å¢åŠ 

**æ–°å¢ç‰¹å¾**ï¼š
- `position_20d`ï¼šå¸®åŠ© AI åˆ¤æ–­å½“å‰æ˜¯æ´—ç›˜è¿˜æ˜¯æ‹‰å‡
- `position_250d`ï¼šå¸®åŠ© AI åˆ¤æ–­æ˜¯å¦çªç ´å¹´çº¿
- `std_20_ratio`ï¼šå¸®åŠ© AI åˆ¤æ–­å¸‚åœºæ³¢åŠ¨æƒ…å†µ

### 3. ç¨³å®šæ€§æå‡

**ä¿®å¤å‰**ï¼š
- RSI å¯èƒ½å‡ºç° `inf`ï¼ˆé™¤é›¶ï¼‰
- NaN å€¼å¯èƒ½å¯¼è‡´è®­ç»ƒå¤±è´¥

**ä¿®å¤å**ï¼š
- æ‰€æœ‰ NaN å’Œ inf éƒ½è¢«æ›¿æ¢ä¸º 0
- ä¿è¯è®­ç»ƒè¿‡ç¨‹çš„ç¨³å®šæ€§

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šæ–œç‡å½’ä¸€åŒ–

```python
# æ„é€ é«˜ä»·è‚¡å’Œä½ä»·è‚¡
é«˜ä»·è‚¡ = pd.DataFrame({'close': [1500, 1515, 1530]})  # ä¸Šæ¶¨1%
ä½ä»·è‚¡ = pd.DataFrame({'close': [5, 5.05, 5.10]})     # ä¸Šæ¶¨1%

# ä¿®å¤å‰
é«˜ä»·è‚¡æ–œç‡ = 30
ä½ä»·è‚¡æ–œç‡ = 0.05
# é«˜ä»·è‚¡ / ä½ä»·è‚¡ = 600å€ âŒ

# ä¿®å¤å
é«˜ä»·è‚¡æ–œç‡ = 1.0  # ç™¾åˆ†æ¯”
ä½ä»·è‚¡æ–œç‡ = 1.0  # ç™¾åˆ†æ¯”
# é«˜ä»·è‚¡ / ä½ä»·è‚¡ = 1å€ âœ…
```

### æµ‹è¯•2ï¼šRSI é™¤é›¶ä¿æŠ¤

```python
# è¿ç»­ä¸Šæ¶¨14å¤©
price = pd.Series([10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23])

# ä¿®å¤å‰ï¼šrsi = inf âŒ
# ä¿®å¤åï¼šrsi = 100 âœ…
```

### æµ‹è¯•3ï¼šç›¸å¯¹ä½ç½®

```python
# æ¨¡æ‹Ÿä¸Šæ¶¨è¶‹åŠ¿
price = pd.Series([10, 11, 12, 13, 14, 15])

# position = (15 - 10) / (15 - 10) = 1.0
# AI å¯ä»¥åˆ¤æ–­ï¼šå½“å‰å¤„äºé«˜ä½
```

---

## ğŸ“‹ ä½¿ç”¨å»ºè®®

### 1. æ•°æ®å‡†å¤‡

ç¡®ä¿æ•°æ®åŒ…å«ä»¥ä¸‹åˆ—ï¼š
- `close`, `high`, `low`, `open`ï¼šåŸå§‹ä»·æ ¼
- `close_qfq`, `high_qfq`, `low_qfq`, `open_qfq`ï¼šå¤æƒä»·æ ¼
- `vol_ratio`, `turnover_rate`, `pe_ttm`ï¼šåŸºç¡€æ•°æ®
- `pct_chg`ï¼šæ¶¨è·Œå¹…

### 2. ç‰¹å¾æå–

```python
from feature_extractor import FeatureExtractor

extractor = FeatureExtractor()
features = extractor.extract_features(df)

# è¿”å› 24 ä¸ªç‰¹å¾
# æ‰€æœ‰å€¼éƒ½æ˜¯åŸå§‹å€¼ï¼Œæ²¡æœ‰å½’ä¸€åŒ–
# é€‚åˆ XGBoost/LightGBM ç›´æ¥ä½¿ç”¨
```

### 3. æ¨¡å‹è®­ç»ƒ

```python
from ai_referee import AIReferee
from sklearn.preprocessing import StandardScaler

# å¦‚æœä½¿ç”¨ XGBoost/LightGBMï¼Œç›´æ¥ä½¿ç”¨
referee = AIReferee(model_type='xgboost')
referee.train(X, Y)

# å¦‚æœä½¿ç”¨ç¥ç»ç½‘ç»œï¼Œéœ€è¦å½’ä¸€åŒ–
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸éœ€è¦æ‰‹åŠ¨å½’ä¸€åŒ–

- **XGBoost/LightGBM**ï¼šä¸éœ€è¦å½’ä¸€åŒ–ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹ç‰¹å¾
- **ç¥ç»ç½‘ç»œ**ï¼šåœ¨è®­ç»ƒç®¡é“é‡ŒåŠ  `StandardScaler`ï¼Œä¸è¦å†™æ­»åœ¨æå–å™¨é‡Œ

### 2. å¤æƒä»·æ ¼ä¼˜å…ˆ

ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å¤æƒä»·æ ¼ï¼ˆ`close_qfq`ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå§‹ä»·æ ¼ï¼ˆ`close`ï¼‰ã€‚

### 3. æ•°æ®é•¿åº¦è¦æ±‚

- æœ€å°æ•°æ®é•¿åº¦ï¼š30å¤©
- å»ºè®®æ•°æ®é•¿åº¦ï¼š120å¤©ä»¥ä¸Šï¼ˆè®¡ç®—æ›´å‡†ç¡®ï¼‰

---

## ğŸ” ç‰¹å¾é‡è¦æ€§é¢„æœŸ

æ ¹æ®é‡‘èç»éªŒï¼Œé¢„æœŸç‰¹å¾é‡è¦æ€§æ’åºï¼š

1. **`position_250d`**ï¼šé•¿æœŸä½ç½®ï¼ˆçªç ´å¹´çº¿ï¼‰
2. **`ma20_slope`**ï¼šä¸­æœŸè¶‹åŠ¿æ–œç‡
3. **`rsi_14`**ï¼šè¶…ä¹°è¶…å–
4. **`std_20_ratio`**ï¼šæ³¢åŠ¨ç‡
5. **`moneyflow_score`**ï¼šèµ„é‡‘æµ
6. **`bias_20`**ï¼šä¸­æœŸä¹–ç¦»ç‡
7. **`new_score`**ï¼šç»¼åˆè¯„åˆ†
8. **`position_20d`**ï¼šçŸ­æœŸä½ç½®
9. **`pct_chg_20d`**ï¼šä¸­æœŸæ¶¨è·Œå¹…
10. `ma5_slope`ï¼šçŸ­æœŸè¶‹åŠ¿æ–œç‡

---

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼Œè§£å†³äº†å››ä¸ªå…³é”®é—®é¢˜ï¼š

1. âœ… **æ–œç‡å½’ä¸€åŒ–**ï¼šæ¶ˆé™¤é«˜ä½ä»·è‚¡å·®å¼‚ï¼ŒAIå¯ä»¥è·¨è‚¡ç¥¨å­¦ä¹ 
2. âœ… **é™¤é›¶ä¿æŠ¤**ï¼šé¿å… RSI ç­‰æŒ‡æ ‡å‡ºç° inf
3. âœ… **åˆ é™¤ç²—æš´å½’ä¸€åŒ–**ï¼šä¿ç•™åŸå§‹ç‰©ç†å«ä¹‰ï¼Œé€‚åˆæ ‘æ¨¡å‹
4. âœ… **å¢åŠ å…³é”®ç‰¹å¾**ï¼šæ³¢åŠ¨ç‡å’Œç›¸å¯¹ä½ç½®ï¼Œæå‡ä¿¡æ¯é‡

è¿™äº›ä¼˜åŒ–ä½¿å¾—ç‰¹å¾æ›´é€‚åˆæœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒï¼Œé¢„æœŸä¼šæ˜¾è‘—æå‡ AI è£åˆ¤çš„é¢„æµ‹å‡†ç¡®ç‡ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æ›´æ–°æ—¥æœŸ**ï¼š2025-01-29
**ä½œè€…**ï¼šDeepQuant Team
