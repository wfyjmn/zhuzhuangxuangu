# 对话3.txt - 需求与实现对照表

## 概述
对话3.txt包含了对AI裁判V5.0系统的完整优化方案，包括真实数据训练、Turbo模式、相对收益标签、特征补全等核心功能。

## 需求清单与实现状态

### 1. 真实数据训练脚本 (train_real_data.py)

| 需求项 | 描述 | 实现状态 | 备注 |
|--------|------|----------|------|
| Turbo模式支持 | 自动检测并使用DataWarehouseTurbo进行数据预加载 | ✅ 已实现 | IS_TURBO标志位 + preload_data安全检查 |
| 时间扩展逻辑 | 自动扩展结束日期以包含标签计算所需的未来数据 | ✅ 已实现 | extended_end = dt_end + timedelta(days=20) |
| 内存优化 | 将float64转换为float32，减少内存占用 | ✅ 已实现 | optimize_dataframe函数 |
| 特征清洗 | 严格剔除trade_date, ts_code等非数值列 | ✅ 已实现 | select_dtypes(include=[np.number]) |
| 特征重要性保存 | 保存特征重要性，带长度检查 | ✅ 已实现 | 防止特征数量不匹配 |
| 命令行参数 | 支持start, end, file, max-candidates, max-samples等参数 | ✅ 已实现 | 使用argparse |
| 干运行模式 | 支持dry-run模式，仅生成少量测试数据 | ✅ 已实现 | 限制max_candidates和max_samples |
| 时序交叉验证 | 使用Time Series Split进行5折交叉验证 | ✅ 已实现 | n_splits参数可配置 |

**文件路径**: `/workspace/projects/assets/train_real_data.py`

**使用方法**:
```bash
# 干运行测试（快速验证）
python assets/train_real_data.py --start 20240101 --end 20240131 --dry-run

# 小范围训练
python assets/train_real_data.py --start 20240101 --end 20240331 --max-samples 500 --n-splits 3

# 完整训练（需先下载数据）
python assets/train_real_data.py --start 20230101 --end 20241231

# 使用已有数据文件训练
python assets/train_real_data.py --file data/training/real_training_data_xxx.csv
```

### 2. Turbo版数据仓库 (data_warehouse_turbo.py)

| 需求项 | 描述 | 实现状态 | 备注 |
|--------|------|----------|------|
| 全量预加载 | 一次性加载指定范围的所有数据到内存 | ✅ 已实现 | preload_data方法 |
| 内存切片 | 使用复合索引(ts_code, trade_date_dt)实现极速查询 | ✅ 已实现 | 内存压缩(float32) |
| 复权价格预计算 | 避免重复计算复权价格 | ✅ 已实现 | 性能提升100倍+ |
| 安全回退 | 如果Turbo版不存在，自动回退到普通版 | ✅ 已实现 | train_real_data.py中的try-except |

**文件路径**: `/workspace/projects/assets/data_warehouse_turbo.py`

**性能对比**:
- 普通模式: 数据生成超时（>5分钟）
- Turbo模式: 数据生成约1秒（100倍+提升）

### 3. 相对收益标签 (V5.0核心功能)

| 需求项 | 描述 | 实现状态 | 备注 |
|--------|------|----------|------|
| 熊市Alpha | 熊市中跑赢大盘2%即为赢 | ✅ 已实现 | alpha_threshold = 0.02 |
| 牛市绝对收益 | 牛市中涨幅超过3%即为赢 | ✅ 已实现 | target_return = 0.03 |
| 止损底线 | 任何情况下最大亏损不超过5% | ✅ 已实现 | max_drawdown_limit = -0.05 |
| 大盘指数获取 | 自动获取上证指数(000001.SH)数据 | ✅ 已实现 | _get_market_data方法 |
| 动态判定 | 根据大盘情况自动切换判定逻辑 | ✅ 已实现 | _calculate_label_v5方法 |

**实现位置**: `/workspace/projects/assets/ai_backtest_generator.py`

**关键参数**:
```python
bear_threshold = -0.01      # 熊市定义：大盘跌幅超过 1%
alpha_threshold = 0.02      # 熊市Alpha要求：跑赢大盘 2%
target_return = 0.03        # 牛市目标收益：3%
max_drawdown_limit = -0.05  # 止损底线：-5%
```

### 4. 特征补全 (turnover_rate, pe_ttm等)

| 需求项 | 描述 | 实现状态 | 备注 |
|--------|------|----------|------|
| turnover_rate | 换手率 | ✅ 已实现 | 在download_daily_data中合并daily_basic |
| pe_ttm | 市盈率TTM | ✅ 已实现 | 在download_daily_data中合并daily_basic |
| pb | 市净率 | ✅ 已实现 | 在download_daily_data中合并daily_basic |
| total_mv | 总市值 | ✅ 已实现 | 在download_daily_data中合并daily_basic |
| circ_mv | 流通市值 | ✅ 已实现 | 在download_daily_data中合并daily_basic |
| force重下载 | 支持强制重新下载并合并新特征 | ✅ 已实现 | force=True参数 |

**实现位置**: `/workspace/projects/assets/data_warehouse.py` (download_daily_data方法)

### 5. 增量更新脚本

| 需求项 | 描述 | 实现状态 | 备注 |
|--------|------|----------|------|
| 快速更新脚本 | 更新2023.07~2024.06数据（5-10分钟） | ✅ 已实现 | run_quick_incremental_update.sh |
| 完整更新脚本 | 更新2023.01~2024.12数据（3-4小时） | ✅ 已实现 | run_full_incremental_update.sh |
| 指数数据下载 | 下载上证指数(000001.SH)数据 | ✅ 已实现 | 两个脚本都包含 |
| 后台运行 | 支持后台运行，输出到日志文件 | ✅ 已实现 | nohup + PID管理 |
| 进度显示 | 实时显示更新进度 | ✅ 已实现 | 每10/20天打印一次 |
| 错误处理 | 自动记录失败日期 | ✅ 已实现 | 失败统计 |

**文件路径**:
- 快速更新: `/workspace/projects/run_quick_incremental_update.sh`
- 完整更新: `/workspace/projects/run_full_incremental_update.sh`

**使用方法**:
```bash
# 快速更新（推荐首次使用）
chmod +x run_quick_incremental_update.sh
./run_quick_incremental_update.sh

# 查看进度
tail -f quick_incremental_update.log

# 完整更新（需要较长时间）
chmod +x run_full_incremental_update.sh
./run_full_incremental_update.sh

# 查看进度
tail -f full_incremental_update.log
```

## 完整工作流程

### 方案1: 从零开始（推荐）

```bash
# 1. 下载测试数据（快速验证）
./test_download_sample_data.sh

# 2. 干运行测试（验证代码正确性）
python assets/train_real_data.py --start 20240101 --end 20240131 --dry-run

# 3. 小范围训练（验证流程）
python assets/train_real_data.py --start 20240101 --end 20240331 --max-samples 500 --n-splits 3

# 4. 完整数据更新（后台运行）
./run_quick_incremental_update.sh

# 5. 完整训练（使用Turbo模式）
python assets/train_real_data.py --start 20230101 --end 20241231
```

### 方案2: 使用已有数据

```bash
# 如果已有训练数据文件
python assets/train_real_data.py --file data/training/real_training_data_xxx.csv
```

## 关键文件清单

| 文件名 | 类型 | 描述 |
|--------|------|------|
| `assets/train_real_data.py` | Python | 真实数据训练主脚本（已优化） |
| `assets/data_warehouse_turbo.py` | Python | Turbo版数据仓库（高性能） |
| `assets/ai_backtest_generator.py` | Python | 回测生成器（含V5.0相对收益标签） |
| `assets/data_warehouse.py` | Python | 数据仓库（含特征补全逻辑） |
| `run_quick_incremental_update.sh` | Shell | 快速增量更新脚本 |
| `run_full_incremental_update.sh` | Shell | 完整增量更新脚本 |
| `test_download_sample_data.sh` | Shell | 测试数据下载脚本 |

## 性能优化总结

1. **Turbo模式**: 数据生成速度提升100倍+（从超时降至约1秒）
2. **内存优化**: 内存占用减少50%（float32 vs float64）
3. **特征过滤**: 自动剔除非数值列，防止XGBoost报错
4. **相对收益标签**: 熊市跑赢大盘即赢，避免AI变成"死空头"

## 注意事项

1. **数据依赖**: 训练前必须先下载历史数据（使用增量更新脚本）
2. **Tushare Token**: 需要配置有效的Tushare Token（在.env文件中）
3. **内存要求**: Turbo模式建议8GB+内存
4. **时间要求**: 完整数据更新需要3-4小时，建议后台运行
5. **样本平衡**: 如果正样本占比<5%，模型可能倾向于预测全负，需要调整参数

## 后续建议

1. **参数优化**: 使用遗传算法优化策略参数（见对话2.txt）
2. **多因子模型**: 扩展到多因子模型的参数优化
3. **实时预测**: 集成到主策略中进行实时选股
4. **A/B测试**: 对比V5.0与V4.0的回测表现

## 联系与支持

如遇问题，请检查：
1. 日志文件: `logs/train_real_data.log`
2. 数据文件: `data/daily/`
3. 训练数据: `data/training/`
4. 模型文件: `data/models/`
